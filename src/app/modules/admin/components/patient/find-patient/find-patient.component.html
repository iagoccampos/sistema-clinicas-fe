<form [formGroup]="findPatientsForm" autocomplete="off">
	<div class="row">
		<div class="col">
			<app-input label="Nome" controlName="name"></app-input>
		</div>
		<div class="col">
			<app-input label="Data de nascimento" type="date" controlName="birthday"></app-input>
		</div>
	</div>

	<div class="row">
		<div class="col">
			<app-input label="RG" controlName="rg" mask="rg"></app-input>
		</div>
		<div class="col">
			<app-input label="CPF" controlName="cpf" mask="cpf"></app-input>
		</div>
		<div class="col">
			<app-input label="Ficha" controlName="card"></app-input>
		</div>
	</div>
	<button type="button" mat-flat-button color="accent" class="mb-3" (click)="clearForm()">Limpar</button>
</form>

<app-center-spinner [loading$]="loading$" [hideTarget]="table"></app-center-spinner>

<div class="mat-elevation-z8" #table>
	<div class="mat-table-container">
		<table mat-table [dataSource]="patients$" multiTemplateDataRows>
			<ng-container matColumnDef="card">
				<th mat-header-cell *matHeaderCellDef> Ficha </th>
				<td mat-cell *matCellDef="let patient"> {{ patient.card }} </td>
			</ng-container>

			<ng-container matColumnDef="name">
				<th mat-header-cell *matHeaderCellDef> Nome </th>
				<td mat-cell *matCellDef="let patient"> {{ patient.name }} </td>
			</ng-container>

			<ng-container matColumnDef="rg">
				<th mat-header-cell *matHeaderCellDef> RG </th>
				<td mat-cell *matCellDef="let patient"> {{ patient.rg | rg | orDash }} </td>
			</ng-container>

			<ng-container matColumnDef="cpf">
				<th mat-header-cell *matHeaderCellDef> CPF </th>
				<td mat-cell *matCellDef="let patient"> {{ patient.cpf | cpf | orDash }} </td>
			</ng-container>

			<ng-container matColumnDef="birthday">
				<th mat-header-cell *matHeaderCellDef> Data nasc. </th>
				<td mat-cell *matCellDef="let patient"> {{ (patient.birthday | date) | orDash }} </td>
			</ng-container>

			<ng-container matColumnDef="actions">
				<th mat-header-cell *matHeaderCellDef> Ações </th>
				<td mat-cell *matCellDef="let patient">
					<button mat-icon-button type="button" color="accent" (click)="$event.stopPropagation(); updatePatient(patient)">
						<mat-icon>edit</mat-icon>
					</button>
					<button mat-icon-button type="button" color="warn" (click)="$event.stopPropagation(); deletePatient(patient)">
						<mat-icon>delete</mat-icon>
					</button>
				</td>
			</ng-container>

			<ng-container matColumnDef="expand">
				<th mat-header-cell *matHeaderCellDef aria-label="row actions">&nbsp;</th>
				<td mat-cell *matCellDef="let patient">
					<button mat-icon-button aria-label="expand row" (click)="(expandedPatient = expandedPatient === patient ? null : patient); $event.stopPropagation()">
						<mat-icon *ngIf="expandedPatient !== patient">keyboard_arrow_down</mat-icon>
						<mat-icon *ngIf="expandedPatient === patient">keyboard_arrow_up</mat-icon>
					</button>
				</td>
			</ng-container>

			<ng-container matColumnDef="expandedDetail">
				<td mat-cell *matCellDef="let patient" [attr.colspan]="columnsToDisplayWithExpand.length">
					<div [@detailExpand]="patient === expandedPatient ? 'expanded' : 'collapsed'">
						Telefones:
						<div class="row">
							<div class="col-3" *ngFor="let phone of patient.phones">
								<p>{{ phone | phone }}</p>
							</div>
						</div>
							<div class="row">
								<div class="col-3">
									<p>Criado em: {{ patient.createdAt | date }}</p>
								</div>
								<div class="col-3">
									<p>Ultima alteração em: {{ patient.updatedAt | date }}</p>
								</div>
							</div>
					</div>
				</td>
			</ng-container>

			<tr mat-header-row *matHeaderRowDef="columnsToDisplayWithExpand"></tr>
			<tr mat-row *matRowDef="let patient; columns: columnsToDisplayWithExpand;"
					class="table-row"
					[class.expanded-row]="expandedPatient === patient"
					(click)="expandedPatient = expandedPatient === patient ? null : patient">
			</tr>
			<tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="detail-row"></tr>
			<tr class="mat-row" *matNoDataRow>
				<td class="mat-cell" [attr.colspan]="columnsToDisplay.length">
					Nenhum paciente cadastrado
				</td>
			</tr>
		</table>
	</div>

	<mat-paginator></mat-paginator>
</div>
